

#!/bin/bash

printf "\n"
cat <<EOF
â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â€ƒâ€ƒâ–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â€ƒâ€ƒâ–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â€ƒâ€ƒâ–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–‘â–ˆâ–ˆâ•”â•â•â•â•â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â€ƒâ€ƒâ•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â€ƒâ€ƒâ–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â–‘â•šâ•â•â•â•â•â–‘
EOF

printf "\n\n"

##########################################################################################
#                                                                                        
#                ğŸš€ æ­¤è„šæœ¬ç”± **@nhxao** éª„å‚²åœ°åˆ›å»ºï¼ğŸš€                 
#                                                                                        
#             ğŸŒ åŠ å…¥æˆ‘ä»¬åœ¨å»ä¸­å¿ƒåŒ–ç½‘ç»œå’ŒåŠ å¯†åˆ›æ–°ä¸­çš„é©å‘½ï¼ ğŸŒ             
#                                                                                                                                                                                                  
##########################################################################################

# ç”¨äºå¹¿å‘Šçš„ç»¿è‰²
GREEN="\033[0;32m"
RESET="\033[0m"

# ç¡®ä¿å®‰è£…æ‰€éœ€çš„è½¯ä»¶åŒ…
echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–é¡¹..."
sudo apt update -y && sudo apt install -y pciutils libgomp1 curl wget build-essential libglvnd-dev pkg-config libopenblas-dev libomp-dev
sudo apt upgrade -y && sudo apt update

# æ£€æµ‹æ˜¯å¦åœ¨ WSL ç¯å¢ƒä¸­è¿è¡Œ
IS_WSL=false
if grep -qi microsoft /proc/version; then
    IS_WSL=true
    echo "ğŸ–¥ï¸ åœ¨ WSL ç¯å¢ƒä¸­è¿è¡Œã€‚"
else
    echo "ğŸ–¥ï¸ åœ¨åŸç”Ÿ Ubuntu ç³»ç»Ÿä¸Šè¿è¡Œã€‚"
fi

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ NVIDIA GPU
check_nvidia_gpu() {
    if command -v nvidia-smi &> /dev/null || lspci | grep -i nvidia &> /dev/null; then
        echo "âœ… æ£€æµ‹åˆ° NVIDIA GPUã€‚"
        return 0
    else
        echo "âš ï¸ æœªæ‰¾åˆ° NVIDIA GPUã€‚"
        return 1
    fi
}

# æ£€æŸ¥ç³»ç»Ÿç±»å‹æ˜¯ VPSã€ç¬”è®°æœ¬ç”µè„‘è¿˜æ˜¯å°å¼æœº
check_system_type() {
    vps_type=$(systemd-detect-virt)
    if echo "$vps_type" | grep -qiE "kvm|qemu|vmware|xen|lxc"; then
        echo "âœ… è¿™æ˜¯ä¸€å° VPSã€‚"
        return 0  # VPS
    elif ls /sys/class/power_supply/ | grep -q "^BAT[0-9]"; then
        echo "âœ… è¿™æ˜¯ä¸€å°ç¬”è®°æœ¬ç”µè„‘ã€‚"
        return 1  # ç¬”è®°æœ¬ç”µè„‘
    else
        echo "âœ… è¿™æ˜¯ä¸€å°å°å¼æœºã€‚"
        return 2  # å°å¼æœº
    fi
}

# æ£€æŸ¥æ˜¯å¦å·²å®‰è£… CUDA
check_cuda_installed() {
    if command -v nvcc &> /dev/null; then
        CUDA_VERSION=$(nvcc --version | grep -oP 'release \K\d+\.\d+' | cut -d. -f1)
        echo "âœ… å·²å®‰è£… CUDA ç‰ˆæœ¬ $CUDA_VERSIONã€‚"
        return 0
    else
        echo "âš ï¸ æœªå®‰è£… CUDAã€‚"
        return 1
    fi
}

# åœ¨ WSL æˆ– Ubuntu 24.04 ä¸Šå®‰è£… CUDA Toolkit 12.8 çš„å‡½æ•°
install_cuda() {
    if $IS_WSL; then
        echo "ğŸ–¥ï¸ ä¸º WSL 2 å®‰è£… CUDA..."
        # å®šä¹‰ WSL çš„æ–‡ä»¶åå’Œ URL
        PIN_FILE="cuda-wsl-ubuntu.pin"
        PIN_URL="https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-wsl-ubuntu.pin"
        DEB_FILE="cuda-repo-wsl-ubuntu-12-8-local_12.8.0-1_amd64.deb"
        DEB_URL="https://developer.download.nvidia.com/compute/cuda/12.8.0/local_installers/cuda-repo-wsl-ubuntu-12-8-local_12.8.0-1_amd64.deb"
    else
        echo "ğŸ–¥ï¸ ä¸º Ubuntu 24.04 å®‰è£… CUDA..."
        # å®šä¹‰ Ubuntu 24.04 çš„æ–‡ä»¶åå’Œ URL
        PIN_FILE="cuda-ubuntu2404.pin"
        PIN_URL="https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-ubuntu2404.pin"
        DEB_FILE="cuda-repo-ubuntu2404-12-8-local_12.8.0-570.86.10-1_amd64.deb"
        DEB_URL="https://developer.download.nvidia.com/compute/cuda/12.8.0/local_installers/cuda-repo-ubuntu2404-12-8-local_12.8.0-570.86.10-1_amd64.deb"
    fi

    # ä¸‹è½½ .pin æ–‡ä»¶
    echo "ğŸ“¥ æ­£åœ¨ä» $PIN_URL ä¸‹è½½ $PIN_FILE..."
    wget "$PIN_URL" || { echo "âŒ æ— æ³•ä¸‹è½½ $PIN_FILE ä» $PIN_URL"; exit 1; }

    # å°† .pin æ–‡ä»¶ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
    sudo mv "$PIN_FILE" /etc/apt/preferences.d/cuda-repository-pin-600 || { echo "âŒ æ— æ³•å°† $PIN_FILE ç§»åŠ¨åˆ° /etc/apt/preferences.d/"; exit 1; }

    # å¦‚æœå­˜åœ¨ .deb æ–‡ä»¶ï¼Œåˆ™åˆ é™¤å¹¶ä¸‹è½½æ–°å‰¯æœ¬
    if [ -f "$DEB_FILE" ]; then
        echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤ç°æœ‰çš„ $DEB_FILE..."
        rm -f "$DEB_FILE"
    fi
    echo "ğŸ“¥ æ­£åœ¨ä» $DEB_URL ä¸‹è½½ $DEB_FILE..."
    wget "$DEB_URL" || { echo "âŒ æ— æ³•ä¸‹è½½ $DEB_FILE ä» $DEB_URL"; exit 1; }

    # å®‰è£… .deb æ–‡ä»¶
    sudo dpkg -i "$DEB_FILE" || { echo "âŒ æ— æ³•å®‰è£… $DEB_FILE"; exit 1; }

    # å¤åˆ¶å¯†é’¥ç¯
    sudo cp /var/cuda-repo-*/cuda-*-keyring.gpg /usr/share/keyrings/ || { echo "âŒ æ— æ³•å°† CUDA å¯†é’¥ç¯å¤åˆ¶åˆ° /usr/share/keyrings/"; exit 1; }

    # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨å¹¶å®‰è£… CUDA Toolkit 12.8
    echo "ğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
    sudo apt-get update || { echo "âŒ æ— æ³•æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨"; exit 1; }
    echo "ğŸ”§ æ­£åœ¨å®‰è£… CUDA Toolkit 12.8..."
    sudo apt-get install -y cuda-toolkit-12-8 || { echo "âŒ æ— æ³•å®‰è£… CUDA Toolkit 12.8"; exit 1; }

    echo "âœ… CUDA Toolkit 12.8 å®‰è£…æˆåŠŸã€‚"
    setup_cuda_env
}

# è®¾ç½® CUDA ç¯å¢ƒå˜é‡
setup_cuda_env() {
    echo "ğŸ”§ æ­£åœ¨è®¾ç½® CUDA ç¯å¢ƒå˜é‡..."
    echo 'export PATH=/usr/local/cuda-12.8/bin${PATH:+:${PATH}}' | sudo tee /etc/profile.d/cuda.sh
    echo 'export LD_LIBRARY_PATH=/usr/local/cuda-12.8/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}' | sudo tee -a /etc/profile.d/cuda.sh
    source /etc/profile.d/cuda.sh
}

# ä½¿ç”¨é€‚å½“çš„ CUDA æ”¯æŒå®‰è£… GaiaNet
install_gaianet() {
    if command -v nvcc &> /dev/null; then
        CUDA_VERSION=$(nvcc --version | grep 'release' | awk '{print $6}' | cut -d',' -f1 | sed 's/V//g' | cut -d'.' -f1)
        echo "âœ… æ£€æµ‹åˆ° CUDA ç‰ˆæœ¬ï¼š$CUDA_VERSION"
        if [[ "$CUDA_VERSION" == "11" || "$CUDA_VERSION" == "12" ]]; then
            echo "ğŸ”§ ä½¿ç”¨ ggmlcuda $CUDA_VERSION å®‰è£… GaiaNet..."
            curl -sSfL 'https://github.com/GaiaNet-AI/gaianet-node/releases/download/0.4.21/install.sh' -o install.sh
            chmod +x install.sh
            ./install.sh --ggmlcuda $CUDA_VERSION || { echo "âŒ ä½¿ç”¨ CUDA å®‰è£… GaiaNet å¤±è´¥ã€‚"; exit 1; }
            return
        fi
    fi
    echo "âš ï¸ ä¸ä½¿ç”¨ GPU æ”¯æŒå®‰è£… GaiaNet..."
    curl -sSfL 'https://github.com/GaiaNet-AI/gaianet-node/releases/download/0.4.20/install.sh' | bash || { echo "âŒ ä¸ä½¿ç”¨ GPU å®‰è£… GaiaNet å¤±è´¥ã€‚"; exit 1; }
}

# å°† GaiaNet æ·»åŠ åˆ° PATH
add_gaianet_to_path() {
    echo 'export PATH=$HOME/gaianet/bin:$PATH' >> ~/.bashrc
    source ~/.bashrc
}

# ä¸»é€»è¾‘
if check_nvidia_gpu; then
    if ! setup_cuda_env; then
        echo "âš ï¸ CUDA ç¯å¢ƒæœªè®¾ç½®ã€‚æ­£åœ¨æ£€æŸ¥æ˜¯å¦å·²å®‰è£… CUDA..."
        if check_cuda_installed; then
            echo "âš ï¸ CUDA å·²å®‰è£…ä½†æœªæ­£ç¡®è®¾ç½®ã€‚è¯·ä¿®å¤ CUDA ç¯å¢ƒã€‚"
        else
            echo "CUDA æœªå®‰è£…ã€‚æ­£åœ¨å®‰è£… CUDA..."
            if install_cuda; then
                echo "âœ… CUDA å®‰è£…æˆåŠŸã€‚"
                setup_cuda_env
            else
                echo "âŒ æ— æ³•å®‰è£… CUDAã€‚æ­£åœ¨é€€å‡ºã€‚"
                exit 1
            fi
        fi
    else
        echo "âœ… CUDA ç¯å¢ƒå·²è®¾ç½®ã€‚"
    fi
fi

# å®‰è£… GaiaNet
install_gaianet

# éªŒè¯ GaiaNet å®‰è£…
if [ -f ~/gaianet/bin/gaianet ]; then
    echo "âœ… GaiaNet å®‰è£…æˆåŠŸã€‚"
    add_gaianet_to_path
else
    echo "âŒ GaiaNet å®‰è£…å¤±è´¥ã€‚æ­£åœ¨é€€å‡ºã€‚"
    exit 1
fi

# ç¡®å®šç³»ç»Ÿç±»å‹å¹¶è®¾ç½®é…ç½® URL
check_system_type
SYSTEM_TYPE=$?  # æ•è· check_system_type çš„è¿”å›å€¼

if [[ $SYSTEM_TYPE -eq 0 ]]; then
    # VPS
    CONFIG_URL="https://raw.githubusercontent.com/abhiag/Gaia_Node/main/Hyper_3.2-3B.json"
elif [[ $SYSTEM_TYPE -eq 1 ]]; then
    # ç¬”è®°æœ¬ç”µè„‘
    if ! check_nvidia_gpu; then
        CONFIG_URL="https://raw.githubusercontent.com/abhiag/Gaia_Node/main/Hyper_3.2-3B.json"
    else
        CONFIG_URL="https://raw.githubusercontent.com/abhiag/Gaia_Node/main/Soneium2.5-0.5B.json"
    fi
elif [[ $SYSTEM_TYPE -eq 2 ]]; then
    # å°å¼æœº
    if ! check_nvidia_gpu; then
        CONFIG_URL="https://raw.githubusercontent.com/abhiag/Gaia_Node/main/Hyper_3.2-3B.json"
    else
        CONFIG_URL="https://raw.githubusercontent.com/abhiag/Gaia_Node/main/gadao3.2_1B.json"
    fi
fi

# åˆå§‹åŒ–å¹¶å¯åŠ¨ GaiaNet
echo "âš™ï¸ æ­£åœ¨åˆå§‹åŒ– GaiaNet..."
~/gaianet/bin/gaianet init --config "$CONFIG_URL" || { echo "âŒ GaiaNet åˆå§‹åŒ–å¤±è´¥ï¼"; exit 1; }

echo "ğŸš€ æ­£åœ¨å¯åŠ¨ GaiaNet èŠ‚ç‚¹..."
~/gaianet/bin/gaianet config --domain gaia.domains
~/gaianet/bin/gaianet start || { echo "âŒ é”™è¯¯ï¼šæ— æ³•å¯åŠ¨ GaiaNet èŠ‚ç‚¹ï¼"; exit 1; }

echo "ğŸ” æ­£åœ¨è·å– GaiaNet èŠ‚ç‚¹ä¿¡æ¯..."
~/gaianet/bin/gaianet info || { echo "âŒ é”™è¯¯ï¼šæ— æ³•è·å– GaiaNet èŠ‚ç‚¹ä¿¡æ¯ï¼"; exit 1; }

# ç»“æŸæ¶ˆæ¯
echo "==========================================================="
echo "ğŸ‰ æ­å–œï¼æ‚¨çš„ GaiaNet èŠ‚ç‚¹å·²æˆåŠŸè®¾ç½®ï¼"
echo "ğŸ’ª è®©æˆ‘ä»¬ä¸€èµ·æ„å»ºå»ä¸­å¿ƒåŒ–ç½‘ç»œçš„æœªæ¥ï¼"
echo "===========================================================" 

